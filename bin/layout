#!/usr/bin/env bash

inprog=$(ps -ef | rg layout | rg -v rg | wc -l)
if [[ "$inprog" -gt 2 ]]; then
    notify-send -u critical -t 2000 "ERROR: layout already in progress."
    exit 0
fi

a_flag="" # [a]plication
n_flag="" # [w]orkspace
s_flag="" # [s]ession (kitty)
w_flag="" # [w]ebsite

while getopts 'a:d:n:w:s:' flag; do
  case "$flag" in
    a) a_flag="$OPTARG" ;;
    s) s_flag="$OPTARG" ;;
    n) n_flag="$OPTARG" ;;
    w) w_flag="$OPTARG" ;;
    *) exit 1 ;;
  esac
done

if [[ "$#" == 0 ]]; then
    exit 1
fi

windows=$(hyprctl workspaces | grep -A 1 "ID $n_flag" | grep -oP '\windows:\s+\K[0-9]+')
if [[ "$windows" -gt 2 ]]; then
    notify-send -u critical -t 2000 "ERROR: layout already open."
    exit 1
fi

browser () {
    firefox-developer-edition --new-window "$w_flag" & sleep 1.5
}

terminal () {
    if [[ -n "$1" ]]; then
        kitty --session ~/.config/kitty/sessions/"$1".conf & sleep 1
    else
        kitty --session ~/.config/kitty/sessions/pipes.conf & sleep 1
    fi
}

resize () {
    hyprctl dispatch resizeactive exact 1870 1186
    hyprctl dispatch movefocus l
    hyprctl dispatch resizeactive exact 1866 1955
    for ((i = 0; i < 5; i++)); do
        hyprctl dispatch resizeactive exact 1012 1955
    done # have resize master several times (bug?) тон
}

visualizer () {
    glava -e "rc_radial_right.glsl" & disown
    glava -e "rc_bars_bot.glsl" & disown
}


# ============================================================================
hyprctl keyword input:follow_mouse 0

hyprctl dispatch workspace "$n_flag"
case "$n_flag" in
    1|2) "$a_flag" & sleep 5 ;;
    3|4)
        terminal "$s_flag"
        browser
        resize
    ;;
    *) exit 1 ;;
esac

hyprctl keyword input:follow_mouse 1

if [[ "$windows" -lt 2 ]]; then
    visualizer
fi
# ============================================================================

exit 0
