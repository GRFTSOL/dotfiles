#!/usr/bin/env bash

dir=/tmp/eww
WEATHER_JSON="$dir/weather.json"
AIR_JSON="$dir/air.json"
WAIT=60

get_json () {
    read -ra location <<<"$(<"$HOME/.local/.location")"
    lat="${location[0]}"
    lon="${location[1]}"
    api=$(<"$HOME/.local/.owm_api_key")
    units="metric"
    weahterUrl="https://api.openweathermap.org/data/3.0/onecall?lat=$lat&lon=$lon&units=$units&exclude=hourly,daily,minutely&appid=$api"

    while true; do
        online=1
        connection () {
            nc -z 8.8.8.8 53  >/dev/null 2>&1
            online=$?
        }

        while [[ "$online" -eq 1 ]]; do
            connection
            sleep 0.5
        done

        start=$(date "+%s")
        end=$(( start + 10000))
        airUrl="http://api.openweathermap.org/data/2.5/air_pollution/history?lat=$lat&lon=$lon&start=$start&end=$end&appid=$api"

        curl "$weahterUrl" | jq > "$WEATHER_JSON"
        curl "$airUrl" | jq > "$AIR_JSON"
        sleep "$WAIT"
    done
}

beaufort () {
    wind_speed=$(jq -r ".current.wind_speed" "$WEATHER_JSON")
    knots=$(echo "$wind_speed * 1.943844" | bc)
    knots=$(echo "$knots" | awk '{print int($1+0.5)}')

    if [[ knots -lt 1 ]]; then
        beaufort_force=0
        desc="calm"
    elif [[ knots -lt 4 ]]; then
        beaufort_force=1
        desc="light air"
    elif [[ knots -lt 7 ]]; then
        beaufort_force=2
        desc="light breeze"
    elif [[ knots -lt 11 ]]; then
        beaufort_force=3
        desc="gentle breeze"
    elif [[ knots -lt 17 ]]; then
        beaufort_force=4
        desc="moderate breeze"
    elif [[ knots -lt 22 ]]; then
        beaufort_force=5
        desc="fresh breeze"
    elif [[ knots -lt 28 ]]; then
        beaufort_force=6
        desc="strong breeze"
    elif [[ knots -lt 34 ]]; then
        beaufort_force=7
        desc="near gale"
    elif [[ knots -lt 41 ]]; then
        beaufort_force=8
        desc="gale"
    elif [[ knots -lt 48 ]]; then
        beaufort_force=9
        desc="strong gale"
    elif [[ knots -lt 56 ]]; then
        beaufort_force=10
        desc="storm"
    elif [[ knots -lt 64 ]]; then
        beaufort_force=11
        desc="violent storm"
    else
        beaufort_force=12
        desc="hurricane"
    fi

    case "$beaufort_force" in
        0) icon="" ;;
        1) icon="" ;;
        2) icon="" ;;
        3) icon="" ;;
        4) icon="" ;;
        5) icon="" ;;
        6) icon="" ;;
        7) icon="" ;;
        8) icon="" ;;
        9) icon="" ;;
        10) icon="" ;;
        11) icon="" ;;
        12) icon="" ;;
    esac

    echo "$icon" >> "$dir/bf-icon"
    echo "$desc" >> "$dir/bf-desc"
}

valid_json () {
    main=$(jq -r ".current.weather[0].main" "$WEATHER_JSON")
    # check for empty (-z) string (indicating downloading/error or some kind)
    if [[ -z "$main" ]]; then
        return 1 # false
    else
        return 0 # true
    fi
}

continuous () {
    while true; do
        valid_json=1
        while ! [[ $valid_json ]] ; do
            sleep 0.25
            valid_json=$(valid_json)
        done
        beaufort
        sleep "$WAIT"
    done
}
        # echo "{\
        #     \"status\":\"Paused\",\
        #     \"volume\":\"0\",\
        #     \"artist\":\"YouTube Music\",\
        #     \"album\":\"Waiting for player to start...\",\
        #     \"title\":\"Waiting for player to start...\"\
        # }" > '/tmp/eww/w.json'

"$1"
