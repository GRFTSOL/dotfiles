#!/usr/bin/env bash

DIR=/tmp/eww
WEATHER_JSON="$DIR/open-weather.json"
AIR_JSON="$DIR/air.json"
WAIT=60
valid_json="false"

online=1
connection () {
    nc -z 8.8.8.8 53  >/dev/null 2>&1
    online=$?
}

get_json () {
    read -ra location <<<"$(<"$HOME/.local/.location")"
    lat="${location[0]}"
    lon="${location[1]}"
    api=$(<"$HOME/.local/.owm_api_key")
    units="metric"
    weahterUrl="https://api.openweathermap.org/data/3.0/onecall?lat=$lat&lon=$lon&units=$units&exclude=hourly,daily,minutely&appid=$api"

    while [[ "$online" -eq 1 ]]; do
        valid_json="false"
        connection
        sleep 0.5
    done

    start=$(date "+%s")
    end=$(( start + 5000 ))
    airUrl="http://api.openweathermap.org/data/2.5/air_pollution/history?lat=$lat&lon=$lon&start=$start&end=$end&appid=$api"

    curl "$weahterUrl" | jq > "$WEATHER_JSON"
    curl "$airUrl" | jq > "$AIR_JSON"
    valid_json="true"
}

while true; do
    while [[ "$valid_json" == "false" ]] ; do
        get_json
    done

    id_main=$(jq -r ".current.weather[0].id" "$WEATHER_JSON")
    id_sec=$(jq -r ".current.weather[1].id" "$WEATHER_JSON")
    sunrise=$(jq -r ".current.sunrise" "$WEATHER_JSON")
    sunrise=$(date -d @"$sunrise" +"%H:%M")
    sunset=$(jq -r ".current.sunset" "$WEATHER_JSON")
    sunset=$(date -d @"$sunset" +"%H:%M")
    temp=$(jq -r ".current.temp" "$WEATHER_JSON")
    feels_like=$(jq -r ".current.feels_like" "$WEATHER_JSON")
    uvi=$(jq -r ".current.uvi" "$WEATHER_JSON")
    clouds=$(jq -r ".current.clouds" "$WEATHER_JSON")

    wind_speed=$(jq -r ".current.wind_speed" "$WEATHER_JSON")
    wind_deg=$(jq -r ".current.wind_deg" "$WEATHER_JSON")
    knots=$(echo "$wind_speed * 1.943844" | bc)
    knots=$(echo "$knots" | awk '{print int($1+0.5)}')

    if [[ knots -lt 1 ]]; then
        bf_icon=" "
        bf_desc="calm"
    elif [[ knots -lt 4 ]]; then
        bf_icon=" "
        bf_desc="light air"
    elif [[ knots -lt 7 ]]; then
        bf_icon=" "
        bf_desc="light breeze"
    elif [[ knots -lt 11 ]]; then
        bf_icon=" "
        bf_desc="gentle breeze"
    elif [[ knots -lt 17 ]]; then
        bf_icon=" "
        bf_desc="moderate breeze"
    elif [[ knots -lt 22 ]]; then
        bf_icon=" "
        bf_desc="fresh breeze"
    elif [[ knots -lt 28 ]]; then
        bf_icon=" "
        bf_desc="strong breeze"
    elif [[ knots -lt 34 ]]; then
        bf_icon=" "
        bf_desc="near gale"
    elif [[ knots -lt 41 ]]; then
        bf_icon=" "
        bf_desc="gale"
    elif [[ knots -lt 48 ]]; then
        bf_icon=" "
        bf_desc="strong gale"
    elif [[ knots -lt 56 ]]; then
        bf_icon=" "
        bf_desc="storm"
    elif [[ knots -lt 64 ]]; then
        bf_icon=" "
        bf_desc="violent storm"
    else
        bf_icon=" "
        bf_desc="hurricane"
    fi

    if [[ $wind_deg -lt 45 ]]; then
        wind_icon=" " # north
    elif [[ $wind_deg -lt 90 ]]; then
        wind_icon=" " # north-east
    elif [[ $wind_deg -lt 135 ]]; then
        wind_icon=" " # east
    elif [[ $wind_deg -lt 225 ]]; then
        wind_icon=" " # south-east
    elif [[ $wind_deg -lt 180 ]]; then
        wind_icon=" " # south
    elif [[ $wind_deg -lt 225 ]]; then
        wind_icon=" " # south-west
    elif [[ $wind_deg -lt 270 ]]; then
        wind_icon=" " # west
    elif [[ $wind_deg -lt 315 ]]; then
        wind_icon=" " # north-west
    else
        wind_icon=" " # north
    fi

    echo "{\
        \"id_main\":\"$id_main\",\
        \"id_sec\":\"$id_sec\",\
        \"bf_icon\":\"$bf_icon\",\
        \"bf_desc\":\"$bf_desc\",\
        \"wind_icon\":\"$wind_icon\",\
        \"wind_deg\":\"$wind_deg\",\
        \"sunrise\":\"$sunrise\",\
        \"sunset\":\"$sunset\",\
        \"temp\":\"$temp\",\
        \"feels_like\":\"$feels_like\",\
        \"uvi\":\"$uvi\",\
        \"clouds\":\"$clouds\"\
    }" > '/tmp/eww/weather.json'

    sleep "$WAIT"
done
