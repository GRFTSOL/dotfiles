#!/usr/bin/env bash

SIDE_WINDOW='1001 1202'
CENTER_WINDOW='1668 1800'
d_flag=""
a_flag=""
n_flag=""
w_flag=""

inprog=$(ps -ef | rg layout | rg -v rg | wc -l)
if [[ "$inprog" -gt 2 ]]; then
    notify-send -u critical -t 2000 "ERROR: layout already in progress."
    exit 1
fi

while getopts 'a:A:d:n:w:' flag; do
  case "$flag" in
    a) a_flag="$OPTARG" ;;
    d) d_flag="$OPTARG" ;;
    n) n_flag="$OPTARG" ;;
    w) w_flag="$OPTARG" ;;
    *) exit 1 ;;
  esac
done

if [[ "$#" == 0 ]]; then
    exit 1
fi

browser () {
    firefox-developer-edition --new-window "$w_flag" & sleep 1.5
}

terminal () {
    dir=''
    case "$d_flag" in
        "eww") dir=".config/eww/";;
        "nvim") dir=".config/nvim/";;
        "vagari") dir="vagari/";;
        "media") dir="media/" ;;
        *) dir="dotfiles/" ;;
    esac
    kitty --working-directory="$HOME/$dir" & sleep 0.5
}

cava () {
    kitty --hold -o font_size=10.0 --title="cava" -c ".config/kitty/kitty.conf" -c ".config/kitty/nobg.conf" -e cava & sleep 0.5
    hyprctl dispatch movefocus l
    hyprctl dispatch resizeactive "exact $SIDE_WINDOW"
    hyprctl dispatch movefocus r
}

code () {
    kitty --working-directory="$HOME/dotfiles/" & sleep 0.5
    hyprctl dispatch movefocus l
    hyprctl dispatch resizeactive "exact $CENTER_WINDOW"
    hyprctl dispatch movefocus r
    kitty --title="invis" & sleep 0.5
    hyprctl dispatch movefocus u
    hyprctl dispatch resizeactive "exact $SIDE_WINDOW"
    guvcview & sleep 0.5
    hyprctl dispatch movefocus r
}

padding () {
    kitty --title="invis" & sleep 0.5
    hyprctl dispatch movefocus l
    hyprctl dispatch resizeactive "exact $CENTER_WINDOW"
}

online=1
connection () {
    nc -z 8.8.8.8 53  >/dev/null 2>&1
    online=$?
}

while [[ "$online" -eq 1 ]]; do
    connection
    sleep 0.5
done

hyprctl keyword input:follow_mouse 0
pkill guvcview
hyprctl dispatch workspace "$n_flag"

case "$n_flag" in
    1) echo 1
    "$a_flag" & sleep 5;
    browser
    cava
    padding
    ;;
    2) echo 2
    browser
    kitty & sleep 0.5;
    cava
    padding
    ;;
    3|4)
    terminal "$d_flag"
    browser
    cava
    code
    ;;
    *) exit 1 ;;
esac



hyprctl keyword input:follow_mouse 1
notify-send -t 2000 "layout for workspace $n_flag opened"

exit 0
